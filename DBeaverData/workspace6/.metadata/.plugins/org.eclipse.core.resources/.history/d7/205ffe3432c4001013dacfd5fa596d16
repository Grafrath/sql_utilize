use academy_db;

-- 학생 테이블
CREATE TABLE student (
  id INT PRIMARY KEY,
  name VARCHAR(50)
);

INSERT INTO student (id, name) VALUES
(1, '철수'),
(2, '영희'),
(3, '민수');

-- 수강 테이블
CREATE TABLE enroll (
  id INT PRIMARY KEY,
  student_id INT,
  class_name VARCHAR(50),
  constraint STD_FK foreign key  (student_id) REFERENCES student(id)
);

INSERT INTO enroll (id, student_id, class_name) VALUES
(1, 1, '데이터베이스'),
(2, 1, '자바'),
(3, 2, '데이터베이스');

SELECT * FROM student;

SELECT * FROM enroll;

SELECT s.name, e.class_name from student s
inner join enroll e on e.student_id = s.id;

alter table product RENAME product_old;

-- 상품 테이블
CREATE TABLE product (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  price INT
);

INSERT INTO product VALUES
(1, '노트북', 1200000),
(2, '스마트폰', 800000),
(3, '키보드', 50000),
(4, '마우스', 30000),
(5, '모니터', 200000);

-- 주문 테이블
CREATE TABLE order_list (
  order_id INT PRIMARY KEY,
  product_id INT,
  quantity INT,
  order_date DATE,
  FOREIGN KEY (product_id) REFERENCES product(id)
);

INSERT INTO order_list VALUES
(101, 1, 1, '2025-01-01'),
(102, 3, 2, '2025-01-02'),
(103, 2, 1, '2025-01-02'),
(104, 5, 3, '2025-01-03'),
(105, 1, 1, '2025-01-04');

-- 상품이름과 주문수량 조회
SELECT p.name, SUM(l.quantity) AS total_quantity FROM product p
JOIN order_list l ON p.id = l.product_id GROUP BY p.name;

-- 주문된 모든 상품의 상품명, 가격, 주문날짜 조회
SELECT l.order_id, p.name, p.price, l.order_date FROM product p
JOIN order_list l ON p.id = l.product_id ORDER BY l.order_id;

-- 상품이름이 노트북인 주문의 주문id, 수량, 날짜 조회
SELECT l.order_id, l.quantity, l.order_date FROM order_list l
JOIN product p ON p.id = l.product_id WHERE p.name = '노트북';

-- 2025-1-2에 주문된 상품들의 상품 이름과 수량 조회
SELECT p.name, l.quantity FROM order_list l
JOIN product p ON p.id = l.product_id WHERE l.order_date = '2025-01-02';

-- 상품명, 수량, 가격, 주문금액(가격*수량)을 함께 출력
SELECT p.name, SUM(l.quantity) AS total_quantity, p.price, p.price * SUM(l.quantity) AS order_price
FROM product p JOIN order_list l ON p.id = l.product_id GROUP BY p.name, p.price;

-- 2번이상 주문된적 있는 상품의 상품명과 총 주문횟수 조회
SELECT p.name, COUNT(l.order_id) AS order_count FROM product p
JOIN order_list l ON p.id = l.product_id
GROUP BY p.name HAVING COUNT(l.order_id) >= 2;

-- LEFT OUTER JOIN(왼쪽 기준, 왼쪽의 데이터는 다 나오게)
-- 왼쪽 테이블은 조건과 상관없이 다 보여주고, 오른쪽 테이블은 매칭되는 것만 붙이는 JOIN**이다

SELECT s.name, e.class_name FROM student AS s
LEFT JOIN enroll AS e ON s.id = e.student_id;
-- 매칭되는 데이터가 없으면 NULL로 채운다

-- RIGHT OUTER JOIN 왼쪽이 아니라 **오른쪽 테이블을 기준으로 전부 출력**하는 JOIN이다
SELECT s.name, e.class_name FROM student AS s
RIGHT JOIN enroll AS e ON s.id = e.student_id;

-- CROSS JOIN(곱집합, 데카르트 곱) 조건 없이 모든 조합을 다 만들어 버리는 JOIN이다

-- ---------------------------------- 내용 바뀜 -----------------------------------------

-- 상품명과 주문id를 출력하되 주문이 없는 상품도 조회
SELECT p.name, l.order_id FROM product p
LEFT JOIN order_list l ON p.id = l.product_id
ORDER BY p.id;

-- 주문이 한번도 없는 상품의 모든 내용 조회
SELECT p.* FROM product p
LEFT JOIN order_list l ON p.id = l.product_id
WHERE l.order_id IS NULL;

-- 상품명, 총 주문수량 조회
SELECT p.name, COALESCE(SUM(l.quantity), 0) AS total_quantity FROM product p
LEFT JOIN order_list l ON p.id = l.product_id
GROUP BY p.name;
